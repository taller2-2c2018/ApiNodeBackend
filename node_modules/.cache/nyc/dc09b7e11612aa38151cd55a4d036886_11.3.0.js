var cov_x8k5zxnx3=function(){var path='/usr/src/routes/v0/auth/routes.js',hash='216a57f048027a9c26acb1b45fceb513cd54c8f2',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/usr/src/routes/v0/auth/routes.js',statementMap:{'0':{start:{line:1,column:16},end:{line:1,column:34}},'1':{start:{line:2,column:15},end:{line:2,column:51}},'2':{start:{line:3,column:15},end:{line:3,column:31}},'3':{start:{line:4,column:12},end:{line:4,column:33}},'4':{start:{line:5,column:15},end:{line:5,column:32}},'5':{start:{line:6,column:18},end:{line:6,column:52}},'6':{start:{line:8,column:32},end:{line:8,column:33}},'7':{start:{line:10,column:18},end:{line:22,column:1}},'8':{start:{line:11,column:16},end:{line:20,column:3}},'9':{start:{line:21,column:2},end:{line:21,column:54}},'10':{start:{line:28,column:4},end:{line:28,column:38}},'11':{start:{line:30,column:0},end:{line:30,column:13}},'12':{start:{line:32,column:0},end:{line:88,column:2}},'13':{start:{line:41,column:17},end:{line:41,column:38}},'14':{start:{line:42,column:2},end:{line:46,column:3}},'15':{start:{line:43,column:4},end:{line:45,column:6}},'16':{start:{line:48,column:17},end:{line:48,column:34}},'17':{start:{line:49,column:17},end:{line:49,column:34}},'18':{start:{line:51,column:2},end:{line:87,column:4}},'19':{start:{line:65,column:4},end:{line:69,column:5}},'20':{start:{line:66,column:6},end:{line:68,column:7}},'21':{start:{line:70,column:19},end:{line:70,column:44}},'22':{start:{line:71,column:4},end:{line:86,column:6}},'23':{start:{line:72,column:16},end:{line:72,column:47}},'24':{start:{line:73,column:18},end:{line:73,column:108}},'25':{start:{line:74,column:6},end:{line:76,column:7}},'26':{start:{line:75,column:8},end:{line:75,column:28}},'27':{start:{line:77,column:6},end:{line:77,column:41}},'28':{start:{line:78,column:6},end:{line:81,column:18}},'29':{start:{line:83,column:6},end:{line:85,column:7}},'30':{start:{line:90,column:0},end:{line:90,column:23}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:10,column:18},end:{line:10,column:19}},loc:{start:{line:10,column:82},end:{line:22,column:1}},line:10},'1':{name:'(anonymous_1)',decl:{start:{line:40,column:3},end:{line:40,column:4}},loc:{start:{line:40,column:17},end:{line:88,column:1}},line:40},'2':{name:'(anonymous_2)',decl:{start:{line:64,column:10},end:{line:64,column:11}},loc:{start:{line:64,column:21},end:{line:87,column:3}},line:64},'3':{name:'(anonymous_3)',decl:{start:{line:71,column:45},end:{line:71,column:46}},loc:{start:{line:71,column:51},end:{line:82,column:5}},line:71},'4':{name:'(anonymous_4)',decl:{start:{line:82,column:13},end:{line:82,column:14}},loc:{start:{line:82,column:25},end:{line:86,column:5}},line:82}},branchMap:{'0':{loc:{start:{line:42,column:2},end:{line:46,column:3}},type:'if',locations:[{start:{line:42,column:2},end:{line:46,column:3}},{start:{line:42,column:2},end:{line:46,column:3}}],line:42},'1':{loc:{start:{line:65,column:4},end:{line:69,column:5}},type:'if',locations:[{start:{line:65,column:4},end:{line:69,column:5}},{start:{line:65,column:4},end:{line:69,column:5}}],line:65},'2':{loc:{start:{line:74,column:6},end:{line:76,column:7}},type:'if',locations:[{start:{line:74,column:6},end:{line:76,column:7}},{start:{line:74,column:6},end:{line:76,column:7}}],line:74}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0},b:{'0':[0,0],'1':[0,0],'2':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();const express=(cov_x8k5zxnx3.s[0]++,require('express'));const models=(cov_x8k5zxnx3.s[1]++,require('../../../models/sequelize'));const router=(cov_x8k5zxnx3.s[2]++,express.Router());const jwt=(cov_x8k5zxnx3.s[3]++,require('jwt-simple'));const moment=(cov_x8k5zxnx3.s[4]++,require('moment'));const responser=(cov_x8k5zxnx3.s[5]++,require('../../../util/responser'));const SERVER_ADMINISTRADOR_ID=(cov_x8k5zxnx3.s[6]++,1);cov_x8k5zxnx3.s[7]++;let createToken=(id,username,permisos,nombrePila,application_user_id,exp)=>{cov_x8k5zxnx3.f[0]++;let payload=(cov_x8k5zxnx3.s[8]++,{user_id:id,username:username,permisos:permisos,nombre:nombrePila,application_user_id:application_user_id,administrador:application_user_id==SERVER_ADMINISTRADOR_ID,iat:moment().unix(),exp:exp});cov_x8k5zxnx3.s[9]++;return jwt.encode(payload,process.env.TOKEN_SECRET);};var usuarios;const{check,validationResult}=(cov_x8k5zxnx3.s[10]++,require('express-validator/check'));cov_x8k5zxnx3.s[11]++;usuarios=[];cov_x8k5zxnx3.s[12]++;router.post('/',[check('username').exists().withMessage('Falta el username').isEmail().withMessage('Falta el username').trim().normalizeEmail(),check('password').exists().withMessage('Falta el password')],(req,res)=>{cov_x8k5zxnx3.f[1]++;const errors=(cov_x8k5zxnx3.s[13]++,validationResult(req));cov_x8k5zxnx3.s[14]++;if(!errors.isEmpty()){cov_x8k5zxnx3.b[0][0]++;cov_x8k5zxnx3.s[15]++;return res.status(422).json({errors:errors.mapped()});}else{cov_x8k5zxnx3.b[0][1]++;}let username=(cov_x8k5zxnx3.s[16]++,req.body.username);let password=(cov_x8k5zxnx3.s[17]++,req.body.password);cov_x8k5zxnx3.s[18]++;models.Usuario.findOne({where:{email:username},include:[{model:models.Rol,as:'Roles',include:[{model:models.Permiso,as:'Permisos'}]}]}).then(usuario=>{cov_x8k5zxnx3.f[2]++;cov_x8k5zxnx3.s[19]++;if(usuario===null){cov_x8k5zxnx3.b[1][0]++;cov_x8k5zxnx3.s[20]++;return res.status(responser.codes.UNPROCESSABLE_ENTITY).json(responser.createResponse(responser.codes.UNPROCESSABLE_ENTITY,'Nombre de usuario o password incorrecto',null));}else{cov_x8k5zxnx3.b[1][1]++;}let permisos=(cov_x8k5zxnx3.s[21]++,usuario.obtenerPermisos());cov_x8k5zxnx3.s[22]++;usuario.verificarPassword(password).then(()=>{cov_x8k5zxnx3.f[3]++;let exp=(cov_x8k5zxnx3.s[23]++,moment().add(30,'days').unix());var token=(cov_x8k5zxnx3.s[24]++,createToken(usuario.id,username,permisos,usuario.nombre,usuario.application_user_id,exp));cov_x8k5zxnx3.s[25]++;if(usuarios.indexOf(req.body.username)===-1){cov_x8k5zxnx3.b[2][0]++;cov_x8k5zxnx3.s[26]++;usuarios.push(token);}else{cov_x8k5zxnx3.b[2][1]++;}cov_x8k5zxnx3.s[27]++;res.statusCode=responser.codes.OK;cov_x8k5zxnx3.s[28]++;res.json(responser.createSuccessResponseWithMetadata(res.statusCode,{token:token,expires_at:exp},'token'));}).catch(function(){cov_x8k5zxnx3.f[4]++;cov_x8k5zxnx3.s[29]++;return res.status(responser.codes.UNPROCESSABLE_ENTITY).json(responser.createResponse(responser.codes.UNPROCESSABLE_ENTITY,'Nombre de usuario o password incorrecto',null));});});});cov_x8k5zxnx3.s[30]++;module.exports=router;