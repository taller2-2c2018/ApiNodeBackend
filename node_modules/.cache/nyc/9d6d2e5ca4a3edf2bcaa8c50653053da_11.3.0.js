var cov_w4bii3tld=function(){var path='/usr/src/tests/routes/v0/auth/middleware_test.js',hash='13de3799daed5862ce8f4480f2cad0c83a404be0',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/usr/src/tests/routes/v0/auth/middleware_test.js',statementMap:{'0':{start:{line:1,column:0},end:{line:1,column:45}},'1':{start:{line:2,column:11},end:{line:2,column:26}},'2':{start:{line:3,column:21},end:{line:3,column:69}},'3':{start:{line:4,column:13},end:{line:4,column:30}},'4':{start:{line:5,column:10},end:{line:5,column:31}},'5':{start:{line:6,column:13},end:{line:6,column:24}},'6':{start:{line:7,column:18},end:{line:7,column:52}},'7':{start:{line:8,column:16},end:{line:8,column:42}},'8':{start:{line:9,column:14},end:{line:9,column:16}},'9':{start:{line:10,column:15},end:{line:10,column:17}},'10':{start:{line:11,column:15},end:{line:11,column:40}},'11':{start:{line:12,column:9},end:{line:12,column:28}},'12':{start:{line:13,column:17},end:{line:13,column:44}},'13':{start:{line:15,column:25},end:{line:15,column:69}},'14':{start:{line:16,column:23},end:{line:16,column:77}},'15':{start:{line:17,column:23},end:{line:17,column:77}},'16':{start:{line:18,column:26},end:{line:18,column:83}},'17':{start:{line:20,column:26},end:{line:20,column:62}},'18':{start:{line:24,column:14},end:{line:34,column:1}},'19':{start:{line:36,column:0},end:{line:138,column:2}},'20':{start:{line:37,column:2},end:{line:52,column:4}},'21':{start:{line:42,column:4},end:{line:48,column:6}},'22':{start:{line:49,column:4},end:{line:49,column:41}},'23':{start:{line:51,column:4},end:{line:51,column:10}},'24':{start:{line:53,column:2},end:{line:70,column:4}},'25':{start:{line:59,column:4},end:{line:69,column:6}},'26':{start:{line:60,column:6},end:{line:64,column:24}},'27':{start:{line:65,column:6},end:{line:67,column:40}},'28':{start:{line:68,column:6},end:{line:68,column:12}},'29':{start:{line:71,column:2},end:{line:85,column:4}},'30':{start:{line:72,column:4},end:{line:72,column:24}},'31':{start:{line:73,column:4},end:{line:73,column:63}},'32':{start:{line:74,column:4},end:{line:84,column:6}},'33':{start:{line:75,column:6},end:{line:79,column:24}},'34':{start:{line:80,column:6},end:{line:82,column:40}},'35':{start:{line:83,column:6},end:{line:83,column:12}},'36':{start:{line:86,column:2},end:{line:97,column:4}},'37':{start:{line:87,column:4},end:{line:87,column:24}},'38':{start:{line:88,column:4},end:{line:88,column:81}},'39':{start:{line:90,column:4},end:{line:96,column:6}},'40':{start:{line:91,column:6},end:{line:94,column:24}},'41':{start:{line:95,column:6},end:{line:95,column:12}},'42':{start:{line:98,column:2},end:{line:113,column:4}},'43':{start:{line:99,column:4},end:{line:99,column:24}},'44':{start:{line:100,column:4},end:{line:100,column:81}},'45':{start:{line:102,column:4},end:{line:112,column:6}},'46':{start:{line:103,column:6},end:{line:107,column:24}},'47':{start:{line:108,column:6},end:{line:110,column:40}},'48':{start:{line:111,column:6},end:{line:111,column:12}},'49':{start:{line:114,column:2},end:{line:125,column:4}},'50':{start:{line:115,column:4},end:{line:115,column:24}},'51':{start:{line:116,column:4},end:{line:116,column:81}},'52':{start:{line:118,column:4},end:{line:124,column:6}},'53':{start:{line:119,column:6},end:{line:122,column:24}},'54':{start:{line:123,column:6},end:{line:123,column:12}},'55':{start:{line:126,column:2},end:{line:137,column:4}},'56':{start:{line:127,column:4},end:{line:127,column:24}},'57':{start:{line:128,column:4},end:{line:128,column:81}},'58':{start:{line:130,column:4},end:{line:136,column:6}},'59':{start:{line:131,column:6},end:{line:134,column:24}},'60':{start:{line:135,column:6},end:{line:135,column:12}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:36,column:44},end:{line:36,column:45}},loc:{start:{line:36,column:56},end:{line:138,column:1}},line:36},'1':{name:'(anonymous_1)',decl:{start:{line:37,column:13},end:{line:37,column:14}},loc:{start:{line:37,column:29},end:{line:52,column:3}},line:37},'2':{name:'(anonymous_2)',decl:{start:{line:53,column:43},end:{line:53,column:44}},loc:{start:{line:53,column:59},end:{line:70,column:3}},line:53},'3':{name:'next',decl:{start:{line:59,column:51},end:{line:59,column:55}},loc:{start:{line:59,column:63},end:{line:69,column:5}},line:59},'4':{name:'(anonymous_4)',decl:{start:{line:71,column:57},end:{line:71,column:58}},loc:{start:{line:71,column:73},end:{line:85,column:3}},line:71},'5':{name:'next',decl:{start:{line:74,column:51},end:{line:74,column:55}},loc:{start:{line:74,column:63},end:{line:84,column:5}},line:74},'6':{name:'(anonymous_6)',decl:{start:{line:86,column:65},end:{line:86,column:66}},loc:{start:{line:86,column:81},end:{line:97,column:3}},line:86},'7':{name:'next',decl:{start:{line:90,column:51},end:{line:90,column:55}},loc:{start:{line:90,column:63},end:{line:96,column:5}},line:90},'8':{name:'(anonymous_8)',decl:{start:{line:98,column:61},end:{line:98,column:62}},loc:{start:{line:98,column:77},end:{line:113,column:3}},line:98},'9':{name:'next',decl:{start:{line:102,column:52},end:{line:102,column:56}},loc:{start:{line:102,column:64},end:{line:112,column:5}},line:102},'10':{name:'(anonymous_10)',decl:{start:{line:114,column:58},end:{line:114,column:59}},loc:{start:{line:114,column:74},end:{line:125,column:3}},line:114},'11':{name:'next',decl:{start:{line:118,column:49},end:{line:118,column:53}},loc:{start:{line:118,column:61},end:{line:124,column:5}},line:118},'12':{name:'(anonymous_12)',decl:{start:{line:126,column:60},end:{line:126,column:61}},loc:{start:{line:126,column:76},end:{line:137,column:3}},line:126},'13':{name:'next',decl:{start:{line:130,column:49},end:{line:130,column:53}},loc:{start:{line:130,column:61},end:{line:136,column:5}},line:130}},branchMap:{},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0,'57':0,'58':0,'59':0,'60':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0},b:{},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();cov_w4bii3tld.s[0]++;require('dotenv').config({path:'.env.test'});let chai=(cov_w4bii3tld.s[1]++,require('chai'));let authMiddleware=(cov_w4bii3tld.s[2]++,require('../../../../routes/v0/auth/middleware'));let moment=(cov_w4bii3tld.s[3]++,require('moment'));let jwt=(cov_w4bii3tld.s[4]++,require('jwt-simple'));let expect=(cov_w4bii3tld.s[5]++,chai.expect);let errorGetter=(cov_w4bii3tld.s[6]++,require('../../../../util/errors'));let httpMocks=(cov_w4bii3tld.s[7]++,require('node-mocks-http'));// quickly sets up REQUEST and RESPONSE to be passed into Express Middleware
let request=(cov_w4bii3tld.s[8]++,{});// define REQUEST
let response=(cov_w4bii3tld.s[9]++,{});// define RESPONSE
let describe=(cov_w4bii3tld.s[10]++,require('mocha').describe);let it=(cov_w4bii3tld.s[11]++,require('mocha').it);let beforeEach=(cov_w4bii3tld.s[12]++,require('mocha').beforeEach);let validateLoggedUser=(cov_w4bii3tld.s[13]++,authMiddleware.checkIsLoggedWithPermission());let validatePermiso1=(cov_w4bii3tld.s[14]++,authMiddleware.checkIsLoggedWithPermission('permiso1'));let validatePermiso2=(cov_w4bii3tld.s[15]++,authMiddleware.checkIsLoggedWithPermission('permiso2'));let validateOtroPermiso=(cov_w4bii3tld.s[16]++,authMiddleware.checkIsLoggedWithPermission('permisoOtro'));const errorNoAutorizado=(cov_w4bii3tld.s[17]++,errorGetter.getUsuarioNoAutorizado());// const errorTokenExpirado = errorGetter.getTokenExpired()
// TODO: Probar token expirado
let payload=(cov_w4bii3tld.s[18]++,{user_id:1,username:'test@test.com.ar',permisos:['permiso1','permiso2'],iat:moment().unix(),exp:moment().add(1,'days').unix()});cov_w4bii3tld.s[19]++;describe('Prueba autenticacion y permisos',function(){cov_w4bii3tld.f[0]++;cov_w4bii3tld.s[20]++;beforeEach(function(done){cov_w4bii3tld.f[1]++;cov_w4bii3tld.s[21]++;/*
             * before each test, reset the REQUEST and RESPONSE variables
             * to be send into the middle ware
             **/request=httpMocks.createRequest({method:'GET',url:'/test/path?myid=312',query:{myid:'312'}});cov_w4bii3tld.s[22]++;response=httpMocks.createResponse();cov_w4bii3tld.s[23]++;done();// call done so that the next test can run
});cov_w4bii3tld.s[24]++;it('Devolver 401 si el token no existe',function(done){cov_w4bii3tld.f[2]++;cov_w4bii3tld.s[25]++;/*
             * Middleware expects to be passed 3 arguments: request, response, and next.
             * We are going to be manually passing REQUEST and RESPONSE into the middleware
             * and create an function callback for next in which we run our tests
             **/validateLoggedUser(request,response,function next(error){cov_w4bii3tld.f[3]++;cov_w4bii3tld.s[26]++;expect(error.status).not.to.be.an('undefined');cov_w4bii3tld.s[27]++;expect(error.status).to.equal(errorNoAutorizado.status);cov_w4bii3tld.s[28]++;done();});});cov_w4bii3tld.s[29]++;it('Devolver 401 si el token esta mal formado existe',function(done){cov_w4bii3tld.f[4]++;cov_w4bii3tld.s[30]++;request.headers={};cov_w4bii3tld.s[31]++;request.headers.authorization='some authorization header';cov_w4bii3tld.s[32]++;validateLoggedUser(request,response,function next(error){cov_w4bii3tld.f[5]++;cov_w4bii3tld.s[33]++;expect(error.status).not.to.be.an('undefined');cov_w4bii3tld.s[34]++;expect(error.status).to.equal(errorNoAutorizado.status);cov_w4bii3tld.s[35]++;done();});});cov_w4bii3tld.s[36]++;it('No devolver error si el token existe y esta bien formado',function(done){cov_w4bii3tld.f[6]++;cov_w4bii3tld.s[37]++;request.headers={};cov_w4bii3tld.s[38]++;request.headers.authorization=jwt.encode(payload,process.env.TOKEN_SECRET);cov_w4bii3tld.s[39]++;validateLoggedUser(request,response,function next(error){cov_w4bii3tld.f[7]++;cov_w4bii3tld.s[40]++;expect(error).to.be.an('undefined');cov_w4bii3tld.s[41]++;done();});});cov_w4bii3tld.s[42]++;it('Validar que el permiso sea correcto y no es correcto',function(done){cov_w4bii3tld.f[8]++;cov_w4bii3tld.s[43]++;request.headers={};cov_w4bii3tld.s[44]++;request.headers.authorization=jwt.encode(payload,process.env.TOKEN_SECRET);cov_w4bii3tld.s[45]++;validateOtroPermiso(request,response,function next(error){cov_w4bii3tld.f[9]++;cov_w4bii3tld.s[46]++;expect(error.status).not.to.be.an('undefined');cov_w4bii3tld.s[47]++;expect(error.status).to.equal(errorNoAutorizado.status);cov_w4bii3tld.s[48]++;done();});});cov_w4bii3tld.s[49]++;it('Validar que el permiso sea correcto y es correcto',function(done){cov_w4bii3tld.f[10]++;cov_w4bii3tld.s[50]++;request.headers={};cov_w4bii3tld.s[51]++;request.headers.authorization=jwt.encode(payload,process.env.TOKEN_SECRET);cov_w4bii3tld.s[52]++;validatePermiso1(request,response,function next(error){cov_w4bii3tld.f[11]++;cov_w4bii3tld.s[53]++;expect(error).to.be.an('undefined');cov_w4bii3tld.s[54]++;done();});});cov_w4bii3tld.s[55]++;it('Validar que el permiso sea correcto y es correcto 2',function(done){cov_w4bii3tld.f[12]++;cov_w4bii3tld.s[56]++;request.headers={};cov_w4bii3tld.s[57]++;request.headers.authorization=jwt.encode(payload,process.env.TOKEN_SECRET);cov_w4bii3tld.s[58]++;validatePermiso2(request,response,function next(error){cov_w4bii3tld.f[13]++;cov_w4bii3tld.s[59]++;expect(error).to.be.an('undefined');cov_w4bii3tld.s[60]++;done();});});});